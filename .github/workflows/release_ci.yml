name: Pilipala Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  android:
    runs-on: ubuntu-latest
    steps:
      - name: 代码迁出
        uses: actions/checkout@v4

      - name: 构建Java环境
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"
          token: ${{secrets.GIT_TOKEN}}

      - name: 检查缓存
        uses: actions/cache@v4
        id: cache-flutter
        with:
          path: /opt/hostedtoolcache/flutter # 注意：ubuntu-latest 的 flutter 路径可能不同，建议直接依赖 flutter-action 的缓存
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}

      - name: 安装Flutter
        # 移除了 if 判断，让 flutter-action 自行处理或覆盖安装，避免路径问题
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.19.6
          channel: any
          cache: true # 开启 flutter-action 自带缓存

      - name: 下载项目依赖
        run: flutter pub get

      - name: 解码生成 jks
        run: echo $KEYSTORE_BASE64 | base64 -di > android/app/vvex.jks
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

      # 构建分架构包 (Split APKs)
      - name: flutter build apk split
        run: flutter build apk --release --split-per-abi
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD}}

      # 构建通用包 (Fat APK)
      - name: flutter build apk universal
        run: flutter build apk --release
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD}}

      - name: 获取版本号
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >>$GITHUB_OUTPUT

      - name: 重命名应用
        run: |
          # 遍历所有生成的 APK
          for file in build/app/outputs/flutter-apk/app-*.apk; do
            # 匹配 app-x-release.apk 或 app-release.apk
            if [[ $file =~ app-(.*)release.apk ]]; then
              # BASH_REMATCH[1] 会是 "armeabi-v7a-" 或者 空字符串
              suffix=${BASH_REMATCH[1]}
              new_file_name="build/app/outputs/flutter-apk/Pili-${suffix}${{ steps.version.outputs.version }}.apk"
              mv "$file" "$new_file_name"
              echo "Renamed $file to $new_file_name"
            fi
          done

      - name: 上传 Android产物
        uses: actions/upload-artifact@v4
        with:
          name: Pilipala-Android # 区分名字，避免 v4 版本冲突
          path: build/app/outputs/flutter-apk/Pili-*.apk

  iOS:
    runs-on: macos-latest
    steps:
      - name: 代码迁出
        uses: actions/checkout@v4

      - name: 安装Flutter
        uses: subosito/flutter-action@v2
        with:
          cache: true
          flutter-version: 3.19.6

      - name: 下载依赖
        run: flutter pub get

      - name: flutter build ipa
        run: |
          flutter build ios --release --no-codesign
          mkdir -p Payload
          ln -sf ../build/ios/iphoneos/Runner.app Payload/Runner.app
          zip -r9 app.ipa Payload/Runner.app

      - name: 获取版本号
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >>$GITHUB_OUTPUT

      - name: 重命名应用
        run: |
          for file in app.ipa; do
            new_file_name="build/Pili-${{ steps.version.outputs.version }}.ipa"
            mv "$file" "$new_file_name"
          done

      - name: 上传 iOS产物
        uses: actions/upload-artifact@v4
        with:
          name: Pilipala-iOS # 区分名字
          if-no-files-found: error
          path: build/Pili-*.ipa

  upload:
    runs-on: ubuntu-latest
    needs: [android, iOS] # 等待两个任务都完成
    steps:
      - name: 代码迁出
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >>$GITHUB_OUTPUT

      # 下载所有产物
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          # v4 新特性：使用 pattern 匹配多个 artifact
          pattern: Pilipala-*
          merge-multiple: true # 将所有下载的文件合并到同一个目录下
          path: ./release-artifacts

      - name: List files (Debug)
        run: ls -R ./release-artifacts

      - name: Upload Release
        uses: ncipollo/release-action@v1
        with:
          name: v${{ steps.version.outputs.version }}
          token: ${{ secrets.GIT_TOKEN }}
          omitBodyDuringUpdate: true
          omitNameDuringUpdate: true
          omitPrereleaseDuringUpdate: true
          allowUpdates: true
          artifacts: release-artifacts/*
